<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì†Œë¦¬ ë¶„ë¥˜ê¸° (ê³¼í•™ ìˆ˜ì—…ìš© - ìˆ˜ì •ë²„ì „)</title>
    
    <!-- Tailwind CSS (ìŠ¤íƒ€ì¼ë§) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- TensorFlow.js & Speech Commands (AI ëª¨ë¸ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .progress-bar { transition: width 0.3s ease; }
        .active-tab { border-bottom: 2px solid #2563EB; color: #2563EB; font-weight: bold; }
        .inactive-tab { color: #6B7280; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center py-10 px-4">

    <!-- Header -->
    <div class="text-center mb-8 max-w-2xl w-full">
        <h1 class="text-3xl font-bold text-slate-800 mb-2">ğŸ§¬ AI ì†Œë¦¬ ë¶„ë¥˜ ì‹¤í—˜ì‹¤</h1>
        <p class="text-slate-600">Teachable Machine ì˜¤ë””ì˜¤ ëª¨ë¸ ë¶„ì„ ë„êµ¬</p>
    </div>

    <!-- Main Container -->
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden border border-slate-200">
        
        <!-- Step 1: Model Loading -->
        <div class="p-6 border-b border-slate-100 bg-slate-50">
            <label class="block text-sm font-bold text-slate-700 mb-2">1ë‹¨ê³„: í•™ìŠµëœ ëª¨ë¸ ì—°ê²°</label>
            <div class="flex gap-2">
                <input type="text" id="model-url" placeholder="https://teachablemachine.withgoogle.com/models/..." 
                    class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <button onclick="loadModel()" id="load-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors whitespace-nowrap">
                    ëª¨ë¸ ë¡œë“œ
                </button>
            </div>
            <p id="model-status" class="text-xs text-slate-500 mt-2">âš ï¸ í‹°ì²˜ë¸”ë¨¸ì‹ ì˜ 'ì—…ë¡œë“œ(ê³µìœ )' ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        </div>

        <!-- Step 2: Input Method Tabs -->
        <div class="flex border-b border-slate-200" id="tabs-container" style="display:none;">
            <button onclick="switchTab('mic')" id="tab-mic" class="flex-1 py-3 text-center text-sm active-tab transition-colors">
                ğŸ¤ ì‹¤ì‹œê°„ ë§ˆì´í¬
            </button>
            <button onclick="switchTab('file')" id="tab-file" class="flex-1 py-3 text-center text-sm inactive-tab transition-colors">
                ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ
            </button>
        </div>

        <!-- Content Area -->
        <div id="content-area" class="p-6 relative min-h-[300px]" style="display:none;">
            
            <!-- Error Message Box -->
            <div id="error-box" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm mb-4"></div>

            <!-- Tab 1: Microphone -->
            <div id="panel-mic" class="flex flex-col items-center justify-center space-y-6">
                <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center relative">
                    <div id="mic-wave" class="absolute w-full h-full rounded-full border-4 border-blue-400 opacity-0"></div>
                    <span class="text-4xl">ğŸ™ï¸</span>
                </div>
                <button id="mic-toggle-btn" onclick="toggleMic()" 
                    class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform active:scale-95">
                    ë¶„ì„ ì‹œì‘í•˜ê¸°
                </button>
                <p class="text-sm text-slate-500">ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p>
            </div>

            <!-- Tab 2: File Upload -->
            <div id="panel-file" class="hidden flex flex-col items-center justify-center space-y-6">
                <input type="file" id="audio-upload" accept="audio/*" class="hidden" onchange="handleFileUpload(event)">
                <label for="audio-upload" class="cursor-pointer border-2 border-dashed border-slate-300 rounded-xl p-8 w-full text-center hover:bg-slate-50 hover:border-blue-400 transition-colors">
                    <span class="text-2xl block mb-2">ğŸ“‚</span>
                    <span class="text-sm text-slate-600 font-bold">ì˜¤ë””ì˜¤ íŒŒì¼ ì„ íƒ</span>
                    <span id="file-name" class="text-xs text-slate-400 block mt-1">.mp3, .wav íŒŒì¼ ì§€ì›</span>
                </label>
                
                <audio id="audio-player" controls class="w-full hidden"></audio>
                
                <p class="text-xs text-blue-500 bg-blue-50 p-2 rounded w-full text-center">
                    ğŸ’¡ íŒ: ì»´í“¨í„° ìŠ¤í”¼ì»¤ ì†Œë¦¬ë¥¼ ì¼œì£¼ì„¸ìš”.<br>ë§ˆì´í¬ê°€ ìŠ¤í”¼ì»¤ ì†Œë¦¬ë¥¼ ë“£ê³  ë¶„ì„í•©ë‹ˆë‹¤.
                </p>

                <button id="file-analyze-btn" onclick="analyzeFileSafe()" disabled
                    class="bg-slate-300 text-white font-bold py-2 px-6 rounded-lg shadow cursor-not-allowed transition-colors w-full">
                    ë¶„ì„ ì‹œì‘ (ì¬ìƒ)
                </button>
            </div>

            <!-- Results Display -->
            <div id="result-container" class="mt-8 pt-6 border-t border-slate-100 opacity-50 pointer-events-none transition-opacity">
                <div class="text-center mb-6">
                    <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">ê°€ì¥ ë†’ì€ ì •í™•ë„</span>
                    <div id="top-class-name" class="text-3xl font-extrabold text-slate-800 mt-1">-</div>
                    <div id="top-class-score" class="text-xl font-bold text-blue-600">0%</div>
                </div>

                <div id="label-container" class="space-y-3">
                    <!-- Bars inserted via JS -->
                </div>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loader" class="absolute inset-0 bg-white/90 z-50 hidden flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-3"></div>
            <p id="loader-text" class="text-sm font-bold text-slate-600">ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    </div>

    <script>
        let recognizer;
        let isListening = false;
        let classLabels = [];
        const resultContainer = document.getElementById('result-container');
        const loader = document.getElementById('loader');
        const errorBox = document.getElementById('error-box');

        // ëª¨ë¸ ë¡œë“œ
        async function loadModel() {
            const urlInput = document.getElementById('model-url').value.trim();
            if (!urlInput) { alert("ëª¨ë¸ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            const baseURL = urlInput.endsWith('/') ? urlInput : urlInput + '/';
            const checkpointURL = baseURL + "model.json";
            const metadataURL = baseURL + "metadata.json";

            showLoader(true, "ëª¨ë¸ ë¡œë“œ ì¤‘...");
            hideError();

            try {
                recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
                await recognizer.ensureModelLoaded();
                classLabels = recognizer.wordLabels();
                
                document.getElementById('model-status').innerHTML = "âœ… <span class='text-green-600 font-bold'>ëª¨ë¸ ë¡œë“œ ì„±ê³µ!</span> (" + classLabels.length + "ê°œ í´ë˜ìŠ¤)";
                document.getElementById('content-area').style.display = 'block';
                document.getElementById('tabs-container').style.display = 'flex';
                document.getElementById('load-btn').innerText = "ë¡œë“œ ì™„ë£Œ";
                document.getElementById('load-btn').disabled = true;
                document.getElementById('model-url').disabled = true;

                initResultBars();

            } catch (error) {
                showError("ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ê±°ë‚˜ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
                console.error(error);
            } finally {
                showLoader(false);
            }
        }

        // ê²°ê³¼ì°½ ì´ˆê¸°í™”
        function initResultBars() {
            const container = document.getElementById('label-container');
            container.innerHTML = '';
            classLabels.forEach((label, index) => {
                const row = document.createElement('div');
                row.className = "flex items-center text-sm";
                row.innerHTML = `
                    <div class="w-24 font-medium text-slate-600 truncate mr-2 text-right">${label}</div>
                    <div class="flex-1 bg-slate-100 rounded-full h-4 overflow-hidden">
                        <div id="bar-${index}" class="progress-bar bg-blue-500 h-full rounded-full" style="width: 0%"></div>
                    </div>
                    <div id="score-${index}" class="w-12 text-right text-slate-500 text-xs ml-2">0%</div>
                `;
                container.appendChild(row);
            });
            resultContainer.classList.remove('opacity-50', 'pointer-events-none');
        }

        // ì•ˆì „í•œ ë¦¬ìŠ¤ë‹ ì¢…ë£Œ í•¨ìˆ˜
        async function stopListeningSafe() {
            if (recognizer && isListening) {
                try {
                    await recognizer.stopListening();
                    isListening = false;
                } catch (e) {
                    console.log("Stop listening error (ë¬´ì‹œ ê°€ëŠ¥):", e);
                }
            }
            // UI ì´ˆê¸°í™”
            document.getElementById('mic-toggle-btn').classList.remove('bg-red-500', 'animate-pulse');
            document.getElementById('mic-toggle-btn').classList.add('bg-slate-800');
            document.getElementById('mic-toggle-btn').innerText = "ë¶„ì„ ì‹œì‘í•˜ê¸°";
            document.getElementById('mic-wave').classList.remove('animate-ping', 'opacity-75');
            
            const fileBtn = document.getElementById('file-analyze-btn');
            fileBtn.innerText = "ë¶„ì„ ì‹œì‘ (ì¬ìƒ)";
            fileBtn.classList.remove('bg-red-500');
            fileBtn.classList.add('bg-green-600');
        }

        // ì‹¤ì‹œê°„ ë§ˆì´í¬ í† ê¸€
        async function toggleMic() {
            hideError();
            if (isListening) {
                await stopListeningSafe();
            } else {
                startListening("mic");
            }
        }

        // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('file-name').innerText = file.name;
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer.src = URL.createObjectURL(file);
                audioPlayer.classList.remove('hidden');
                
                const analyzeBtn = document.getElementById('file-analyze-btn');
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('bg-slate-300', 'cursor-not-allowed');
                analyzeBtn.classList.add('bg-green-600', 'text-white');
            }
        }

        // [ìˆ˜ì •ë¨] ì•ˆì „í•œ íŒŒì¼ ë¶„ì„ í•¨ìˆ˜
        async function analyzeFileSafe() {
            const audioPlayer = document.getElementById('audio-player');
            const btn = document.getElementById('file-analyze-btn');
            hideError();

            // 1. ì´ë¯¸ ë¶„ì„ ì¤‘ì´ë¼ë©´ ì¤‘ì§€
            if (isListening) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                await stopListeningSafe();
                return;
            }

            // 2. ë¶„ì„ ì‹œì‘ ì‹œë„
            try {
                // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í™•ì‹¤íˆ ì¢…ë£Œ ëŒ€ê¸°
                if (recognizer && recognizer.isListening()) {
                    await recognizer.stopListening();
                }

                // UI ì—…ë°ì´íŠ¸ (ë¶„ì„ ì¤‘ í‘œì‹œ)
                btn.innerText = "ì¤‘ì§€";
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-red-500');

                // 3. ìˆœì„œ ì¤‘ìš”: ë¦¬ìŠ¤ë‹ ë¨¼ì € ì‹œì‘ -> ì¤€ë¹„ë˜ë©´ -> ì˜¤ë””ì˜¤ ì¬ìƒ
                // ì´ë ‡ê²Œ í•´ì•¼ ì•ë¶€ë¶„ì´ ì˜ë¦¬ì§€ ì•Šê³ , ë§ˆì´í¬ ê¶Œí•œ ì˜¤ë¥˜ë¥¼ ë¨¼ì € ì¡ì„ ìˆ˜ ìˆìŒ
                await recognizer.listen(result => {
                    updateResults(result.scores);
                }, {
                    includeSpectrogram: false,
                    probabilityThreshold: 0.75,
                    invokeCallbackOnNoiseAndUnknown: true,
                    overlapFactor: 0.50
                });

                isListening = true;
                
                // ë¦¬ìŠ¤ë‹ ì¤€ë¹„ ì™„ë£Œ í›„ ì¬ìƒ
                setTimeout(() => {
                    audioPlayer.play().catch(e => {
                        showError("ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.");
                        stopListeningSafe();
                    });
                }, 100); // ì•„ì£¼ ì§§ì€ ëŒ€ê¸° ì‹œê°„

                // ì¬ìƒ ëë‚˜ë©´ ìë™ ì¢…ë£Œ
                audioPlayer.onended = async () => {
                    await stopListeningSafe();
                };

            } catch (error) {
                console.error(error);
                let msg = "ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                if (error.name === 'NotAllowedError' || error.message.includes('permission')) {
                    msg = "ë§ˆì´í¬ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”.";
                } else if (window.location.protocol === 'file:') {
                    msg = "ë³´ì•ˆìƒ HTML íŒŒì¼ì„ ì§ì ‘ ì—´ë©´(file://) ë§ˆì´í¬ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì›¹ ì„œë²„ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.";
                }
                showError(msg);
                await stopListeningSafe();
            }
        }

        // ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateResults(scores) {
            let maxScore = -1;
            let maxIndex = -1;

            for (let i = 0; i < scores.length; i++) {
                const scorePercent = Math.round(scores[i] * 100);
                const bar = document.getElementById(`bar-${i}`);
                const scoreText = document.getElementById(`score-${i}`);
                
                if (bar && scoreText) {
                    bar.style.width = `${scorePercent}%`;
                    scoreText.innerText = `${scorePercent}%`;
                    if (scorePercent > 80) bar.className = "progress-bar bg-green-500 h-full rounded-full";
                    else if (scorePercent > 50) bar.className = "progress-bar bg-blue-500 h-full rounded-full";
                    else bar.className = "progress-bar bg-slate-300 h-full rounded-full";
                }

                if (scores[i] > maxScore) {
                    maxScore = scores[i];
                    maxIndex = i;
                }
            }

            const topNameDiv = document.getElementById('top-class-name');
            const topScoreDiv = document.getElementById('top-class-score');
            
            topNameDiv.innerText = classLabels[maxIndex];
            topScoreDiv.innerText = `${Math.round(maxScore * 100)}%`;
            
            if (classLabels[maxIndex] === 'Background Noise') {
                topNameDiv.className = "text-3xl font-extrabold text-slate-400 mt-1";
                topScoreDiv.className = "text-xl font-bold text-slate-400";
            } else {
                topNameDiv.className = "text-3xl font-extrabold text-blue-600 mt-1";
                topScoreDiv.className = "text-xl font-bold text-blue-600";
            }
        }

        // ë§ˆì´í¬ ì „ìš© ì‹œì‘ í•¨ìˆ˜
        async function startListening() {
            try {
                if (recognizer && recognizer.isListening()) {
                    await recognizer.stopListening();
                }

                document.getElementById('mic-toggle-btn').innerText = "ë¶„ì„ ì¤‘ì§€";
                document.getElementById('mic-toggle-btn').classList.remove('bg-slate-800');
                document.getElementById('mic-toggle-btn').classList.add('bg-red-500', 'animate-pulse');
                document.getElementById('mic-wave').classList.add('animate-ping', 'opacity-75');

                await recognizer.listen(result => updateResults(result.scores), {
                    includeSpectrogram: false,
                    probabilityThreshold: 0.75,
                    invokeCallbackOnNoiseAndUnknown: true,
                    overlapFactor: 0.50
                });
                isListening = true;

            } catch (error) {
                showError("ë§ˆì´í¬ë¥¼ ì¼¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                stopListeningSafe();
            }
        }

        // íƒ­ ì „í™˜
        async function switchTab(tab) {
            await stopListeningSafe();
            document.getElementById('audio-player').pause();
            hideError();

            const micBtn = document.getElementById('tab-mic');
            const fileBtn = document.getElementById('tab-file');
            
            if (tab === 'mic') {
                micBtn.className = "flex-1 py-3 text-center text-sm active-tab transition-colors";
                fileBtn.className = "flex-1 py-3 text-center text-sm inactive-tab transition-colors";
                document.getElementById('panel-mic').classList.remove('hidden');
                document.getElementById('panel-file').classList.add('hidden');
            } else {
                micBtn.className = "flex-1 py-3 text-center text-sm inactive-tab transition-colors";
                fileBtn.className = "flex-1 py-3 text-center text-sm active-tab transition-colors";
                document.getElementById('panel-mic').classList.add('hidden');
                document.getElementById('panel-file').classList.remove('hidden');
            }
        }

        function showLoader(show, text="ë¡œë”© ì¤‘...") {
            document.getElementById('loader-text').innerText = text;
            loader.style.display = show ? 'flex' : 'none';
            if(show) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        function showError(msg) {
            errorBox.innerText = "âš ï¸ " + msg;
            errorBox.classList.remove('hidden');
        }

        function hideError() {
            errorBox.classList.add('hidden');
        }
    </script>
</body>
</html>
